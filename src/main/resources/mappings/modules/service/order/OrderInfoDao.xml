<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.service.dao.order.OrderInfoDao">
    
	<sql id="orderInfoColumns">
		a.id AS "id",
		a.master_id AS "masterId",
		a.order_type AS "orderType",
		a.order_number AS "orderNumber",
		a.org_id AS "orgId",
		a.station_id AS "stationId",
		a.major_sort AS "majorSort",
		a.origin_price AS "originPrice",
		a.pay_price AS "payPrice",
		a.order_address_id AS "orderAddressId",
		a.order_time AS "orderTime",
		a.service_time AS "serviceTime",
		a.finish_time AS "finishTime",
		a.order_status AS "orderStatus",
		a.order_source AS "orderSource",
		a.pay_status AS "payStatus",
		a.customer_id AS "customerId",
		a.customer_remark AS "customerRemark",
		a.customer_remark_pic AS "customerRemarkPic",
		a.business_name AS "businessName",
		a.business_phone AS "businessPhone",
		a.business_remark AS "businessRemark",
		a.business_remark_pic AS "businessRemarkPic",
		a.shop_name AS "shopName",
		a.shop_phone AS "shopPhone",
		a.shop_addr AS "shopAddr",
		a.shop_remark AS "shopRemark",
		a.shop_remark_pic AS "shopRemarkPic",
		a.order_remark AS "orderRemark",
		a.order_content AS "orderContent",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag"
	</sql>
	
	<sql id="orderInfoJoins">
	</sql>
    
	<select id="get" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info a
		<include refid="orderInfoJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="OrderInfo">
		SELECT
			a.id AS id,
			a.order_number AS orderNumber,
			addr.name AS customerName,
			addr.phone AS customerPhone,
			a.org_id AS orgId,
			org.name AS orgName,
			a.station_id AS stationId,
			sta.name AS stationName,
			a.order_content AS orderContent,
			a.pay_price AS payPrice,
			a.service_time AS serviceTime,
			a.order_status AS orderStatus,
			a.pay_status AS payStatus,
			a.order_time AS orderTime
		FROM order_info a
		LEFT JOIN order_address addr ON a.order_address_id = addr.id AND addr.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_organization org ON a.org_id = org.id AND org.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_service_station sta ON a.org_id = sta.id AND sta.del_flag = #{DEL_FLAG_NORMAL}
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="orderStatus != null and orderStatus !=''">
				AND a.order_status= #{orderStatus}
			</if>
			<if test="payStatus != null and payStatus !=''">
				AND a.pay_status= #{payStatus}
			</if>
			<if test="orgId != null and orgId !=''">
				AND a.org_id = #{orgId}
			</if>
			<if test="stationId != null and stationId !=''">
				AND a.station_id= #{stationId}
			</if>
			<if test="customerName != null and customerName != ''">
				AND addr.name LIKE concat('%',#{customerName},'%')
			</if>
			<if test="customerPhone != null and customerPhone != ''">
				AND addr.phone LIKE concat('%',#{customerPhone},'%')
			</if>
			<if test="orderNumber != null and orderNumber != ''">
				AND a.order_number LIKE concat('%',#{orderNumber},'%')
			</if>
			<if test="orderContent != null and orderContent != ''">
				AND a.order_content LIKE concat('%',#{orderContent},'%')
			</if>
			<if test="orderTimeStart != null and orderTimeStart != ''">
				AND a.order_time &gt;= #{orderTimeStart}
			</if>
			<if test="orderTimeEnd != null and orderTimeEnd != ''">
				AND a.order_time &lt;= #{orderTimeEnd}
			</if>
			<if test="serviceTime != null and serviceTime != ''">
				AND a.service_time = #{serviceTime}
			</if>
			<!-- 数据范围过滤 -->
			${sqlMap.dsf}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info a
		<include refid="orderInfoJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO order_info(
			id,
			master_id,
			order_type,
			order_number,
			org_id,
			station_id,
			major_sort,
			origin_price,
			pay_price,
			order_address_id,
			order_time,
			service_time,
			finish_time,
			order_status,
			order_source,
			pay_status,
			customer_id,
			customer_remark,
			customer_remark_pic,
			business_name,
			business_phone,
			business_remark,
			business_remark_pic,
			shop_name,
			shop_phone,
			shop_addr,
			shop_remark,
			shop_remark_pic,
			order_remark,
			order_content,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag
		) VALUES (
			#{id},
			#{masterId},
			#{orderType},
			#{orderNumber},
			#{orgId},
			#{stationId},
			#{majorSort},
			#{originPrice},
			#{payPrice},
			#{orderAddressId},
			#{orderTime},
			#{serviceTime},
			#{finishTime},
			#{orderStatus},
			#{orderSource},
			#{payStatus},
			#{customerId},
			#{customerRemark},
			#{customerRemarkPic},
			#{businessName},
			#{businessPhone},
			#{businessRemark},
			#{businessRemarkPic},
			#{shopName},
			#{shopPhone},
			#{shopAddr},
			#{shopRemark},
			#{shopRemarkPic},
			#{orderRemark},
			#{orderContent},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag}
		)
	</insert>
	
	<update id="update">
		UPDATE order_info SET
			<if test="masterId !=null and masterId != ''">master_id = #{masterId},</if>
			<if test="orderType !=null and orderType != ''">order_type = #{orderType},</if>
			<if test="orderNumber !=null and orderNumber != ''">order_number = #{orderNumber},</if>
			<if test="orgId !=null and orgId != ''">org_id = #{orgId},</if>
			<if test="stationId !=null and stationId != ''">station_id = #{stationId},</if>
			<if test="majorSort !=null and majorSort != ''">major_sort = #{majorSort},</if>
			<if test="originPrice !=null and originPrice != ''">origin_price = #{originPrice},</if>
			<if test="payPrice !=null and payPrice != ''">pay_price = #{payPrice},</if>
			<if test="orderAddressId !=null and orderAddressId != ''">order_address_id = #{orderAddressId},</if>
			<if test="orderTime !=null and orderTime != ''">order_time = #{orderTime},</if>
			<if test="serviceTime !=null and serviceTime != ''">service_time = #{serviceTime},</if>
			<if test="finishTime !=null and finishTime != ''">finish_time = #{finishTime},</if>
			<if test="orderStatus !=null and orderStatus != ''">order_status = #{orderStatus},</if>
			<if test="orderSource !=null and orderSource != ''">order_source = #{orderSource},</if>
			<if test="payStatus !=null and payStatus != ''">pay_status = #{payStatus},</if>
			<if test="customerId !=null and customerId != ''">customer_id = #{customerId},</if>
			<if test="customerRemark !=null and customerRemark != ''">customer_remark = #{customerRemark},</if>
			<if test="customerRemarkPic !=null and customerRemarkPic != ''">customer_remark_pic = #{customerRemarkPic},</if>
			<if test="businessName !=null and businessName != ''">business_name = #{businessName},</if>
			<if test="businessPhone !=null and businessPhone != ''">business_phone = #{businessPhone},</if>
			<if test="businessRemark !=null and businessRemark != ''">business_remark = #{businessRemark},</if>
			<if test="businessRemarkPic !=null and businessRemarkPic != ''">business_remark_pic = #{businessRemarkPic},</if>
			<if test="shopName !=null and shopName != ''">shop_name = #{shopName},</if>
			<if test="shopPhone !=null and shopPhone != ''">shop_phone = #{shopPhone},</if>
			<if test="shopAddr !=null and shopAddr != ''">shop_addr = #{shopAddr},</if>
			<if test="shopRemark !=null and shopRemark != ''">shop_remark = #{shopRemark},</if>
			<if test="shopRemarkPic !=null and shopRemarkPic != ''">shop_remark_pic = #{shopRemarkPic},</if>
			<if test="orderRemark !=null and orderRemark != ''">order_remark = #{orderRemark},</if>
			<if test="orderContent !=null and orderContent != ''">order_content = #{orderContent},</if>
			<if test="updateBy.id !=null and updateBy.id != ''">update_by = #{updateBy.id},</if>
			<if test="updateDate !=null and updateDate != ''">update_date = #{updateDate}</if>
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE order_info SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="findOrganizationList" resultType="BasicOrganization">
		SELECT
		a.id AS "id",
		a.name AS "name"
		FROM basic_organization a
		<where>
			a.del_flag = '0'
			<!-- 数据范围过滤 -->
			${sqlMap.dsf}
		</where>
	</select>
	<select id="findServiceTimeList" resultType="ServiceTechnicianWorkTime">
		SELECT * FROM tech_work_time a WHERE a.del_flag = '0'
	</select>
	<select id="formData" resultType="OrderInfo">
		SELECT
			a.id AS "id",
			a.master_id AS "masterId",
			a.order_type AS "orderType",
			a.order_number AS orderNumber,
			a.order_status AS "orderStatus",
			a.order_source AS "orderSource",
			a.order_time AS "orderTime",
			a.org_id AS orgId,
			org.name AS orgName,
			a.station_id AS stationId,
			sta.name AS stationName,

			pay.pay_number AS "payInfo.payNumber",
			pay.pay_status AS "payInfo.payStatus",
			pay.pay_method AS "payInfo.payMethod",
			pay.pay_platform AS "payInfo.payPlatform",
			pay.pay_account AS "payInfo.payAccount",
			pay.pay_time AS "payInfo.payTime",

			ref.refund_number AS "refundInfo.refundNumber",
			ref.refund_account AS "refundInfo.refundAccount",
			ref.refund_status AS "refundInfo.refundStatus",
			ref.apply_time AS "refundInfo.applyTime",
			ref.refund_reason AS "refundInfo.refundReason",

			addr.name AS "addressInfo.name",
			addr.phone AS "addressInfo.phone",
			addr.address AS "addressInfo.address",

			a.customer_remark AS "customerRemark",
			a.customer_remark_pic AS "customerRemarkPic",
			a.order_remark AS "orderRemark",
			a.order_remark_pic AS "orderRemarkPic",
			a.order_content AS "orderContent",
			a.business_name AS "businessName",
			a.business_phone AS "businessPhone",
			a.business_remark AS "businessRemark",
			a.business_remark_pic AS "businessRemarkPic",
			a.shop_name AS "shopName",
			a.shop_phone AS "shopPhone",
			a.shop_addr AS "shopAddr",
			a.shop_remark AS "shopRemark",
			a.shop_remark_pic AS "shopRemarkPic"
		FROM
		order_info a
		LEFT JOIN order_address addr ON a.order_address_id = addr.id AND addr.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN order_pay_info pay ON a.master_id = pay.master_id AND pay.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN order_refund ref ON a.id = ref.order_id AND ref.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_organization org ON a.org_id = org.id AND org.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_service_station sta ON a.org_id = sta.id AND sta.del_flag = #{DEL_FLAG_NORMAL}
		WHERE a.id = #{id}
	</select>

	<select id="getOrderDispatchList" resultType="OrderDispatch">
		SELECT
			a.tech_id AS techId,
			b.name  AS techName,
			b.head_pic  AS headPic,
			b.sex  AS techSex,
			b.phone  AS techPhone
		FROM
		order_dispatch a
		LEFT JOIN tech_info b ON a.tech_id = b.id
		WHERE a.order_id = #{id}
		AND a.status = 'yes'
		AND a.del_flag = #{DEL_FLAG_NORMAL}
	</select>
	<select id="getOrderGoodsList" resultType="OrderGoods">
		SELECT
			a.service_time AS "serviceTime",
			good.item_id AS "itemId",
			good.item_name AS "itemName",
			good.goods_id AS "goodsId",
			good.goods_name AS "goodsName",
			good.goods_num AS "goodsNum",
			good.pay_price AS "payPrice",
			good2.type AS "goodsType",
			good2.min_purchase AS "minPurchase"
		FROM
		order_info a
		LEFT JOIN order_goods good ON a.id = good.order_id AND good.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN ser_item_info_goods good2 ON good.goods_id = good2.id  AND good2.del_flag = #{DEL_FLAG_NORMAL}
		WHERE
		a.id = #{id}
	</select>
	<select id="getGoodsList" resultType="OrderGoods">
		SELECT
		a.item_id AS "itemId",
		b.name AS "itemName",
		a.id AS "goodsId",
		a.name AS "goodsName",
		a.price AS "payPrice",
		a.type AS "goodsType",
		a.min_purchase AS "minPurchase"
		FROM
		ser_item_info_goods a
		LEFT JOIN ser_item_info b ON a.item_id = b.id AND b.del_flag = #{DEL_FLAG_NORMAL}
		WHERE
		a.item_id = #{itemId}
		AND a.del_flag = #{DEL_FLAG_NORMAL}
	</select>
	<update id="cancelData">
		UPDATE order_info SET
			order_status = 'cancel'
		WHERE id = #{id}
	</update>
	<update id="saveTime">
		UPDATE order_info SET
			service_time = #{service_time}
		WHERE id = #{id}
	</update>
</mapper>