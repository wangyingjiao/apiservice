<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.service.dao.order.OrderInfoDao">
    
	<sql id="orderInfoColumns">
		a.id AS "id",
		a.master_id AS "masterId",
		a.order_type AS "orderType",
		a.order_number AS "orderNumber",
		a.org_id AS "orgId",
		a.station_id AS "stationId",
		a.major_sort AS "majorSort",
		a.origin_price AS "originPrice",
		a.pay_price AS "payPrice",
		a.order_address_id AS "orderAddressId",
		a.order_time AS "orderTime",
		a.service_time AS "serviceTime",
		a.finish_time AS "finishTime",
		a.order_status AS "orderStatus",
		a.order_source AS "orderSource",
		a.pay_status AS "payStatus",
		a.customer_id AS "customerId",
		a.customer_remark AS "customerRemark",
		a.customer_remark_pic AS "customerRemarkPic",
		a.business_name AS "businessName",
		a.business_phone AS "businessPhone",
		a.business_remark AS "businessRemark",
		a.business_remark_pic AS "businessRemarkPic",
		a.shop_name AS "shopName",
		a.shop_phone AS "shopPhone",
		a.shop_addr AS "shopAddr",
		a.shop_remark AS "shopRemark",
		a.shop_remark_pic AS "shopRemarkPic",
		a.order_remark AS "orderRemark",
		a.order_content AS "orderContent",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.del_flag AS "delFlag"
	</sql>
	
	<sql id="orderInfoJoins">
	</sql>
    
	<select id="get" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info a
		<include refid="orderInfoJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="OrderInfo">
		SELECT 
			a.order_number AS orderNumber,
			addr.name AS customerName,
			addr.phone AS customerPhone,
			a.org_id AS orgId,
			org.name AS orgName,
			a.station_id AS stationId,
			sta.name AS stationName,
			a.order_content AS orderContent,
			a.pay_price AS payPrice,
			a.origin_price AS originPrice,
			a.service_time AS serviceTime,
			a.order_status AS orderStatus,
			a.pay_status AS payStatus,
			a.order_time AS orderTime
		FROM order_info a
		LEFT JOIN order_address addr ON a.order_address_id = addr.id AND addr.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_organization org ON a.org_id = org.id AND org.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN basic_service_station sta ON a.org_id = sta.id AND sta.del_flag = #{DEL_FLAG_NORMAL}
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="orderStatus != null and orderStatus !=''">
				AND a.order_status= #{orderStatus}
			</if>
			<if test="payStatus != null and payStatus !=''">
				AND a.pay_status= #{payStatus}
			</if>
			<if test="orgId != null and orgId !=''">
				AND a.org_id = #{orgId}
			</if>
			<if test="stationId != null and stationId !=''">
				AND a.station_id= #{stationId}
			</if>
			<if test="customerName != null and customerName != ''">
				AND addr.name LIKE concat('%',#{customerName},'%')
			</if>
			<if test="customerPhone != null and customerPhone != ''">
				AND addr.phone LIKE concat('%',#{customerPhone},'%')
			</if>
			<if test="orderNumber != null and orderNumber != ''">
				AND a.order_number LIKE concat('%',#{orderNumber},'%')
			</if>
			<if test="orderContent != null and orderContent != ''">
				AND a.order_content LIKE concat('%',#{orderContent},'%')
			</if>
			<if test="orderTimeStart != null and orderTimeStart != ''">
				AND a.order_time &gt;= #{orderTimeStart}
			</if>
			<if test="orderTimeEnd != null and orderTimeEnd != ''">
				AND a.order_time &lt;= #{orderTimeEnd}
			</if>
			<if test="serviceTime != null and serviceTime != ''">
				AND a.service_time &lt;= #{serviceTime}
			</if>
			<!-- 数据范围过滤 -->
			${sqlMap.dsf}
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info a
		<include refid="orderInfoJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<insert id="insert">
		INSERT INTO order_info(
			id,
			master_id,
			order_type,
			order_number,
			org_id,
			station_id,
			major_sort,
			origin_price,
			pay_price,
			order_address_id,
			order_time,
			service_time,
			finish_time,
			order_status,
			order_source,
			pay_status,
			customer_id,
			customer_remark,
			customer_remark_pic,
			business_name,
			business_phone,
			business_remark,
			business_remark_pic,
			shop_name,
			shop_phone,
			shop_addr,
			shop_remark,
			shop_remark_pic,
			order_remark,
			order_content,
			create_by,
			create_date,
			update_by,
			update_date,
			del_flag
		) VALUES (
			#{id},
			#{masterId},
			#{orderType},
			#{orderNumber},
			#{orgId},
			#{stationId},
			#{majorSort},
			#{originPrice},
			#{payPrice},
			#{orderAddressId},
			#{orderTime},
			#{serviceTime},
			#{finishTime},
			#{orderStatus},
			#{orderSource},
			#{payStatus},
			#{customerId},
			#{customerRemark},
			#{customerRemarkPic},
			#{businessName},
			#{businessPhone},
			#{businessRemark},
			#{businessRemarkPic},
			#{shopName},
			#{shopPhone},
			#{shopAddr},
			#{shopRemark},
			#{shopRemarkPic},
			#{orderRemark},
			#{orderContent},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{delFlag}
		)
	</insert>
	
	<update id="update">
		UPDATE order_info SET
			<if test="masterId !=null and masterId != ''">master_id = #{masterId},</if>
			<if test="orderType !=null and orderType != ''">order_type = #{orderType},</if>
			<if test="orderNumber !=null and orderNumber != ''">order_number = #{orderNumber},</if>
			<if test="orgId !=null and orgId != ''">org_id = #{orgId},</if>
			<if test="stationId !=null and stationId != ''">station_id = #{stationId},</if>
			<if test="majorSort !=null and majorSort != ''">major_sort = #{majorSort},</if>
			<if test="originPrice !=null and originPrice != ''">origin_price = #{originPrice},</if>
			<if test="payPrice !=null and payPrice != ''">pay_price = #{payPrice},</if>
			<if test="orderAddressId !=null and orderAddressId != ''">order_address_id = #{orderAddressId},</if>
			<if test="orderTime !=null and orderTime != ''">order_time = #{orderTime},</if>
			<if test="serviceTime !=null and serviceTime != ''">service_time = #{serviceTime},</if>
			<if test="finishTime !=null and finishTime != ''">finish_time = #{finishTime},</if>
			<if test="orderStatus !=null and orderStatus != ''">order_status = #{orderStatus},</if>
			<if test="orderSource !=null and orderSource != ''">order_source = #{orderSource},</if>
			<if test="payStatus !=null and payStatus != ''">pay_status = #{payStatus},</if>
			<if test="customerId !=null and customerId != ''">customer_id = #{customerId},</if>
			<if test="customerRemark !=null and customerRemark != ''">customer_remark = #{customerRemark},</if>
			<if test="customerRemarkPic !=null and customerRemarkPic != ''">customer_remark_pic = #{customerRemarkPic},</if>
			<if test="businessName !=null and businessName != ''">business_name = #{businessName},</if>
			<if test="businessPhone !=null and businessPhone != ''">business_phone = #{businessPhone},</if>
			<if test="businessRemark !=null and businessRemark != ''">business_remark = #{businessRemark},</if>
			<if test="businessRemarkPic !=null and businessRemarkPic != ''">business_remark_pic = #{businessRemarkPic},</if>
			<if test="shopName !=null and shopName != ''">shop_name = #{shopName},</if>
			<if test="shopPhone !=null and shopPhone != ''">shop_phone = #{shopPhone},</if>
			<if test="shopAddr !=null and shopAddr != ''">shop_addr = #{shopAddr},</if>
			<if test="shopRemark !=null and shopRemark != ''">shop_remark = #{shopRemark},</if>
			<if test="shopRemarkPic !=null and shopRemarkPic != ''">shop_remark_pic = #{shopRemarkPic},</if>
			<if test="orderRemark !=null and orderRemark != ''">order_remark = #{orderRemark},</if>
			<if test="orderContent !=null and orderContent != ''">order_content = #{orderContent},</if>
			<if test="updateBy.id !=null and updateBy.id != ''">update_by = #{updateBy.id},</if>
			<if test="updateDate !=null and updateDate != ''">update_date = #{updateDate}</if>
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE order_info SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="findOrganizationList" resultType="BasicOrganization">
		SELECT
		a.id AS "id",
		a.name AS "name"
		FROM basic_organization a
		<where>
			a.del_flag = '0'
			<!-- 数据范围过滤 -->
			${sqlMap.dsf}
		</where>
	</select>

</mapper>