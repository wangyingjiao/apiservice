<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.service.dao.order.CombinationOrderDao">

    <sql id="CombinationOrderColumns">
        a.id AS "id",
        a.master_id AS "masterId",
        a.joint_group_id AS "jointGroupId",
        a.order_type AS "orderType",
        a.org_id AS "orgId",
        a.station_id AS "stationId",
        a.major_sort AS "majorSort",
        a.combination_goods_id AS "combinationGoodsId",
        a.combination_goods_name AS "combinationGoodsName",
        a.combination_goods_num AS "combinationGoodsNum",
        a.pay_price AS "payPrice",
        a.origin_price AS "originPrice",
        a.order_address_id AS "orderAddressId",
        a.latitude AS "latitude",
        a.longitude AS "longitude",
        a.order_time AS "orderTime",
        a.service_frequency AS "serviceFrequency",
        a.service_num AS "serviceNum",
        a.service_hour AS "serviceHour",
        a.service_start AS "serviceStart",
        a.tech_id AS "techId",
        a.bespeak_total AS "bespeakTotal",
        a.bespeak_num AS "bespeakNum",
        a.order_status AS "orderStatus",
        a.order_source AS "orderSource",
        a.pay_status AS "payStatus",
        a.customer_id AS "customerId",
        a.eshop_code AS "eshopCode",
        a.shop_id AS "shopId",
        a.shop_name AS "shopName",
        a.shop_phone AS "shopPhone",
        a.shop_addr AS "shopAddr",
        a.order_content AS "orderContent",
        a.cancel_reason AS "cancelReason",
        a.cancel_reason_remark AS "cancelReasonRemark"
    </sql>

    <!--组合订单列表-->
    <select id="listDataCombination" resultType="CombinationOrderInfo">
        SELECT
            a.id AS id,
            a.master_id AS masterId,
            a.combination_goods_name AS combinationGoodsName,
            a.joint_group_id AS jointGroupId,
            a.org_id AS orgId,
            org.name AS orgName,
            a.station_id AS stationId,
            sta.name AS stationName,
            a.order_content AS orderContent,
            a.pay_price AS payPrice,
            a.order_status AS orderStatus,
            a.order_source AS orderSource,
            a.pay_status AS payStatus,
            a.order_time AS orderTime
        FROM order_combination_info a
        LEFT JOIN basic_organization org ON a.org_id = org.id AND org.del_flag = #{DEL_FLAG_NORMAL}
        LEFT JOIN basic_service_station sta ON a.station_id = sta.id AND sta.del_flag = #{DEL_FLAG_NORMAL}
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            <if test="orgId != null and orgId !=''">
                AND a.org_id = #{orgId}
            </if>
            <if test="stationId != null and stationId !=''">
                AND a.station_id= #{stationId}
            </if>
            <if test="startTime != null and startTime != ''">
                AND a.order_time &gt;= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND a.order_time &lt;= #{endTime}
            </if>
            <if test="masterId != null and masterId != ''">
                AND a.master_id LIKE concat('%',#{masterId},'%')
            </if>
            <if test="orderContent != null and orderContent !=''">
                AND a.order_content LIKE concat('%',#{orderContent},'%')
            </if>
            <if test="jointGroupId != null and jointGroupId !=''">
                AND a.joint_group_id LIKE concat('%',#{jointGroupId},'%')
            </if>
        <!-- 数据范围过滤 -->
        ${sqlMap.dsf}
        </where>
            <choose>
                <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                    ORDER BY ${page.orderBy}
                </when>
                <otherwise>
                    ORDER BY a.create_date DESC
            </otherwise>
        </choose>
    </select>

    <!--根据masterId查询组合订单详情-->
    <select id="getCombinationById" resultType="CombinationOrderInfo">
        SELECT
        a.id AS "id",
        a.master_id AS "masterId",
        a.order_type AS "orderType",
        a.major_sort AS "majorSort",
        a.order_status AS "orderStatus",
        a.order_source AS "orderSource",
        a.combination_goods_name AS "combinationGoodsName",
        a.bespeak_total AS "bespeakTotal",
        a.bespeak_num AS "bespeakNum",
        a.order_time AS "orderTime",
        a.service_frequency AS serviceFrequency,
        a.latitude AS latitude,
        a.longitude AS longitude,
        a.origin_price AS originPrice,
        a.org_id AS "orgId",
        org.name AS "orgName",
        a.station_id AS "stationId",
        sta.name AS "stationName",
        a.joint_group_id AS "jointGroupId",
        a.combination_goods_id AS "combinationGoodsId",
        a.combination_goods_num AS "combinationGoodsNum",
        a.pay_price AS payPrice,
        a.pay_status AS "payStatus",
        a.service_num AS "serviceNum",
        pay.pay_number AS "payInfo.payNumber",
        pay.pay_status AS "payInfo.payStatus",
        pay.pay_method AS "payInfo.payMethod",
        pay.pay_platform AS "payInfo.payPlatform",
        pay.pay_account AS "payInfo.payAccount",
        pay.pay_time AS "payInfo.payTime",

        address.name AS "addressInfo.name",
        address.phone AS "addressInfo.phone",
        CONCAT(IFNULL(t1.name,''),IFNULL(t2.name,''),IFNULL(t3.name,''),IFNULL(address.placename,'')) AS "addressInfo.placename",
        address.detail_address AS "addressInfo.detailAddress",
        address.address AS "addressInfo.address",

        a.service_hour AS "serviceHour",
        a.service_start AS "serviceStart",
        a.tech_id AS techId,
        cust.name AS "customerName",
        cust.phone AS "customerPhone",
        a.order_content AS "orderContent",
        a.cancel_reason AS "cancelReason",
        a.cancel_reason_remark AS "cancelReasonRemark",
        tech.name AS "tech.name",
        tech.phone AS "tech.phone"
        FROM
        order_combination_info a
        LEFT JOIN order_pay_info pay ON a.master_id = pay.master_id AND pay.del_flag = #{DEL_FLAG_NORMAL}
        LEFT JOIN basic_organization org ON a.org_id = org.id AND org.del_flag = #{DEL_FLAG_NORMAL}
        LEFT JOIN basic_service_station sta ON a.station_id = sta.id AND sta.del_flag = #{DEL_FLAG_NORMAL}

        LEFT JOIN order_address address ON a.order_address_id = address.id AND address.del_flag = #{DEL_FLAG_NORMAL}
        LEFT JOIN sys_area t1 ON address.province_code = t1.code
        LEFT JOIN sys_area t2 ON address.city_code = t2.code
        LEFT JOIN sys_area t3 ON address.area_code = t3.code

        LEFT JOIN customer_info cust ON a.customer_id = cust.id AND cust.del_flag = #{DEL_FLAG_NORMAL}
        LEFT JOIN tech_info tech ON a.tech_id = tech.id

        WHERE a.master_id = #{masterId} AND a.del_flag = #{DEL_FLAG_NORMAL}
    </select>

    <!--判断是否在组合订单中卫固定技师 可预约次数>已预约次数  订单状态dispatched-->
    <select id="getComCount" resultType="int">
        SELECT
            count(1) AS num
        FROM
        order_combination_info a
        WHERE a.tech_id = #{id}
        AND a.del_flag = #{DEL_FLAG_NORMAL}
        AND a.order_status = 'dispatched'
        AND a.bespeak_total > a.bespeak_num
    </select>

    <select id="getOrderRemark" resultType="OrderInfo">
		SELECT
			a.customer_remark AS "customerRemark",
			a.customer_remark_pic AS "customerRemarkPic",
			a.order_remark AS "orderRemark",
			a.order_remark_pic AS "orderRemarkPic",
			a.business_name AS "businessName",
			a.business_phone AS "businessPhone",
			a.business_remark AS "businessRemark",
			a.business_remark_pic AS "businessRemarkPic",
			a.shop_name AS "shopName",
			a.shop_phone AS "shopPhone",
			a.shop_addr AS "shopAddr",
			a.shop_remark AS "shopRemark",
			a.shop_remark_pic AS "shopRemarkPic"
		FROM
		order_info a
		WHERE a.id = #{orderId} AND a.del_flag = #{DEL_FLAG_NORMAL}
    </select>

    <select id="getOrderDispatchList" resultType="OrderDispatch">
        SELECT
        a.id AS id,
        a.tech_id AS techId,
        b.name  AS techName,
        b.head_pic  AS headPic,
        b.sex  AS techSex,
        b.phone  AS techPhone
        FROM
        order_dispatch a
        LEFT JOIN tech_info b ON a.tech_id = b.id
        WHERE a.order_id = #{orderId}
        AND a.status = 'yes'
        AND a.del_flag = #{DEL_FLAG_NORMAL}
    </select>

    <insert id="insert">
        INSERT INTO order_combination_info(
        id,
        master_id,
        joint_group_id,
        order_type,
        org_id,
        station_id,
        major_sort,
        combination_goods_id,
        combination_goods_name,
        combination_goods_num,
        pay_price,
        origin_price,
        order_address_id,
        latitude,
        longitude,
        order_time,
        service_frequency,
        service_num,
        service_hour,
        service_start,
        tech_id,
        bespeak_total,
        bespeak_num,
        order_status,
        order_source,
        pay_status,
        customer_id,
        eshop_code,
        shop_id,
        shop_name,
        shop_phone,
        shop_addr,
        order_content,
        cancel_reason,
        cancel_reason_remark,
        create_by,
        create_date,
        update_by,
        update_date,
        del_flag
        ) VALUES (
        #{id},
        #{masterId},
        #{jointGroupId},
        #{orderType},
        #{orgId},
        #{stationId},
        #{majorSort},
        #{combinationGoodsId},
        #{combinationGoodsName},
        #{combinationGoodsNum},
        #{payPrice},
        #{originPrice},
        #{orderAddressId},
        #{latitude},
        #{longitude},
        #{orderTime},
        #{serviceFrequency},
        #{serviceNum},
        #{serviceHour},
        #{serviceStart},
        #{techId},
        #{bespeakTotal},
        #{bespeakNum},
        #{orderStatus},
        #{orderSource},
        #{payStatus},
        #{customerId},
        #{eshopCode},
        #{shopId},
        #{shopName},
        #{shopPhone},
        #{shopAddr},
        #{orderContent},
        #{cancelReason},
        #{cancelReasonRemark},
        #{createBy.id},
        #{createDate},
        #{updateBy.id},
        #{updateDate},
        #{delFlag}
        )
    </insert>

    <!--根据masterId获取组合订单-->
    <select id="getCombinationByMasterId"  resultType="CombinationOrderInfo">
        SELECT
        <include refid="CombinationOrderColumns"/>
        FROM
        order_combination_info a
        WHERE a.master_id = #{masterId}
        AND a.del_flag = '0'
    </select>


    <select id="listFrequencyByTechWeek" resultType="OrderCombinationFrequencyInfo">
        select
        a.start_time AS "startTime",
        a.end_time AS "endTime"
        from  order_combination_frequency a ,order_combination_info o
        WHERE
        a.del_flag = #{DEL_FLAG_NORMAL}
        AND o.del_flag = #{DEL_FLAG_NORMAL}
        AND a.week = #{serchWeek}
        AND o.master_id = a.master_id
        AND o.tech_id = #{techId}
        AND o.bespeak_total &gt; o.bespeak_num
        AND o.order_status = 'dispatched'
    </select>

    <update id="updateManyByMasterId">
        UPDATE
        order_combination_info
        SET
        service_frequency = #{serviceFrequency},
        service_num = #{serviceNum},
        service_start = #{serviceStart},
        tech_id = #{techId}
        WHERE master_id = #{masterId}
    </update>
    <update id="updateBespeakByMasterId">
        UPDATE
        order_combination_info
        SET
        bespeak_num = bespeak_num + #{serviceNum}
        WHERE master_id = #{masterId}
    </update>
</mapper>