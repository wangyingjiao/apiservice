<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.service.dao.order.OrderCombinationGasqDao">

    <!--组合并拆单订单对接编号信息-->
    <select id="getListbyMasterId" resultMap="OrderCombinationGasqMap">
        SELECT
        <include refid="OrderCombinationGasqInfo"/>
        FROM order_combination_gasq a
        LEFT JOIN tech_schedule b ON b.type_id=a.order_group_id AND b.del_flag = #{DEL_FLAG_NORMAL}
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            AND a.master_id=#{masterId}
            AND a.order_number is not null
            AND a.order_group_id is not null
        </where>
        GROUP By a.order_group_id
        ORDER BY b.start_time DESC
    </select>
    <!--组合不拆单订单对接编号信息-->
    <select id="getOrderListbyMasterId" resultType="OrderInfo">
        SELECT
            a.id AS "id",
            a.order_number AS "orderNumber",
            a.service_status AS "serviceStatus",
            a.order_time AS "orderTime",
            a.service_time AS "serviceTime",
            a.finish_time AS "finishTime",
            a.order_status AS "orderStatus",
            a.joint_order_id AS "jointOrderId"
        FROM order_info a
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
            AND a.master_id=#{masterId}
        </where>
    </select>

    <sql id="OrderCombinationGasqInfo">
        a.id AS "id",
        a.master_id AS "masterId",
        a.joint_order_sn AS "jointOrderSn",
        a.order_group_id AS "orderGroupId",
        a.order_number AS "orderNumber"
    </sql>

    <resultMap type="OrderCombinationGasqInfo" id="OrderCombinationGasqMap">
        <id column="id" property="id"/>
        <result column="master_id" property="masterId"/>
        <result column="joint_order_sn" property="jointOrderSn"/>
        <result column="orderGroupId" property="orderGroupId"/>
        <result column="orderNumber" property="orderNumber"/>
        <!-- 项目关联商品 -->
        <association property="orderList" column="{reqId=orderGroupId,orderNumber=orderNumber}" select="selectOrderById"></association>
    </resultMap>
    <!--订单-->
    <select id="selectOrderById" parameterType="java.util.Map" resultType="OrderInfo">
        select
            a.id AS "id",
            a.order_number AS "orderNumber",
            a.service_status AS "serviceStatus",
            a.order_time AS "orderTime",
            a.service_time AS "serviceTime",
            a.finish_time AS "finishTime",
            a.order_status AS "orderStatus",
            a.joint_order_id AS "jointOrderId"
        from order_info a
        LEFT JOIN order_combination_gasq b on a.order_number= b.order_number
        where b.order_group_id=#{reqId}
        and a.del_flag = '0'
        ORDER BY a.service_time DESC
    </select>

    <insert id="insert">
        INSERT INTO order_combination_gasq(
        id,
        master_id,
        joint_order_sn,
        order_group_id,
        order_number,
        create_by,
        create_date,
        update_by,
        update_date,
        del_flag
        ) VALUES (
        #{id},
        #{masterId},
        #{jointOrderSn},
        #{orderGroupId},
        #{orderNumber},
        #{createBy.id},
        #{createDate},
        #{updateBy.id},
        #{updateDate},
        #{delFlag}
        )
    </insert>

    <select id="listFreeGasqSn" resultType="OrderCombinationGasqInfo">
        select
            a.id AS "id",
            a.master_id AS "masterId",
            a.joint_order_sn AS "jointOrderSn",
            a.order_group_id AS "orderGroupId",
            a.order_number AS "orderNumber"
         from order_combination_gasq a
         WHERE
            a.del_flag = '0'
            AND a.master_id = #{masterId}
            AND a.order_group_id IS NULL
            AND a.order_number IS NULL
    </select>

    <!--根据orderNumber masterId获取组合订单的orderGroupId-->
    <select id="getListByOrderNumber" resultType="OrderCombinationGasqInfo">
        select
        <include refid="OrderCombinationGasqInfo"/>
        FROM order_combination_gasq a
        WHERE
        a.del_flag = '0'
        AND a.master_id = #{masterId}
        AND a.order_number = #{orderNumber}
    </select>

    <!--根据orderSn masterId获取组合订单-->
    <select id="getGasqByOrderSn" resultType="OrderCombinationGasqInfo">
        select
        <include refid="OrderCombinationGasqInfo"/>
        FROM order_combination_gasq a
        WHERE
        a.del_flag = '0'
        AND a.master_id = #{masterId}
        AND a.joint_order_sn = #{jointOrderSn}
    </select>

    <!--根据groupId获取组合订单的订单集合-->
    <select id="getListByOrderGroupId" resultType="OrderCombinationGasqInfo">
        select
        <include refid="OrderCombinationGasqInfo"/>
        FROM order_combination_gasq a
        WHERE
        a.del_flag = '0'
        AND a.order_group_id = #{orderGroupId}
    </select>

    <update id="updateOrderGroup">
        UPDATE order_combination_gasq SET
        order_group_id = #{orderGroupId},
        order_number = #{orderNumber},
        <if test="updateBy.id !=null and updateBy.id != ''">update_by = #{updateBy.id},</if>
        <if test="updateDate !=null and updateDate != ''">update_date = #{updateDate}</if>
        WHERE id = #{id}
    </update>
    <update id="updateOrderGroupByMasterJointSn">
        UPDATE order_combination_gasq SET
        order_group_id = #{orderGroupId},
        order_number = #{orderNumber},
        <if test="updateBy.id !=null and updateBy.id != ''">update_by = #{updateBy.id},</if>
        <if test="updateDate !=null and updateDate != ''">update_date = #{updateDate}</if>
        WHERE master_id = #{masterId}
        AND joint_order_sn = #{jointOrderSn}
    </update>
    <select id="listGroupOrderByOrderId" resultType="OrderCombinationGasqInfo">
        SELECT
        s1.master_id AS "masterId",
        s1.order_group_id AS "orderGroupId",
        s2.id AS  "orderId",
        s2.order_source AS "orderSource",
        s2.order_number AS "orderNumber"
        from
        order_info o
        INNER JOIN order_combination_gasq g on o.order_number = g.order_number AND g.del_flag = '0'
        LEFT JOIN order_combination_gasq s1 ON s1.order_group_id = g.order_group_id AND s1.del_flag = '0'
        LEFT JOIN order_info s2 ON s1.order_number = s2.order_number AND s2.del_flag = '0'
        WHERE o.id =  #{orderId}
    </select>


    <select id="getListbyOrderId" resultType="OrderCombinationGasqInfo">
        SELECT
        <include refid="OrderCombinationGasqInfo"/>
        FROM order_combination_gasq a
        where
            a.del_flag = #{DEL_FLAG_NORMAL}
            AND a.master_id=#{masterId}
            AND a.order_number=#{orderNumber}
    </select>
</mapper>