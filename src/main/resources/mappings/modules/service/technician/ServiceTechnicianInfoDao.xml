<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.service.dao.technician.ServiceTechnicianInfoDao">

    <sql id="serviceTechnicianInfoColumns">
		a.id AS "id",
		a.tech_office_id AS "techOfficeId",
		a.tech_office_name AS "techOfficeName",
		a.tech_station_id AS "techStationId",
		a.tech_station_name AS "techStationName",
		a.tech_name AS "techName",
		a.tech_id_card AS "techIdCard",
		a.tech_phone AS "techPhone",
		a.status AS "status",
		a.app_login_password AS "appLoginPassword",
		a.bank_type AS "bankType",
		a.bank_card_no AS "bankCardNo",
		a.addr_province_id AS "addrProvinceId",
		a.addr_city_id AS "addrCityId",
		a.addr_district_id AS "addrDistrictId",
		a.addr_province_name AS "addrProvinceName",
		a.addr_city_name AS "addrCityName",
		a.addr_district_name AS "addrDistrictName",
		a.addr_detail_info AS "addrDetailInfo",
		a.tech_sex AS "techSex",
		a.tech_nation AS "techNation",
		a.tech_birth_date AS "techBirthDate",
		a.tech_email AS "techEmail",
		a.tech_education AS "techEducation",
		a.tech_height AS "techHeight",
		a.tech_weight AS "techWeight",
		a.tech_matrimony AS "techMatrimony",
		a.tech_native_place AS "techNativePlace",
		a.sort AS "sort",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.remarks AS "remarks",
		a.del_flag AS "delFlag"
	</sql>

    <sql id="serviceTechnicianInfoJoins">
    </sql>

    <select id="get" resultType="ServiceTechnicianInfo">
        SELECT
        <include refid="serviceTechnicianInfoColumns"/>
        FROM service_technician_info a
        <include refid="serviceTechnicianInfoJoins"/>
        WHERE a.id = #{id}
    </select>

	<select id="getData" resultMap="ServiceTechnicianInfoResultMap">
		SELECT
		<include refid="serviceTechnicianInfoColumnsAll"/>
		FROM service_technician_info a
		left join service_technician_service_info b on a.id = b.tech_id and b.del_flag = '0'
		<where>
			a.id = #{id}
		</where>
	</select>
	<sql id="serviceTechnicianInfoColumnsAll">
		a.id AS "id",
		a.tech_office_id AS "techOfficeId",
		a.tech_office_name AS "techOfficeName",
		a.tech_station_id AS "techStationId",
		a.tech_station_name AS "techStationName",
		a.tech_name AS "techName",
		a.tech_id_card AS "techIdCard",
		a.tech_phone AS "techPhone",
		a.addr_province_id AS "addrProvinceId",
		a.addr_city_id AS "addrCityId",
		a.addr_district_id AS "addrDistrictId",
		a.addr_province_name AS "addrProvinceName",
		a.addr_city_name AS "addrCityName",
		a.addr_district_name AS "addrDistrictName",
		a.addr_detail_info AS "addrDetailInfo",
		a.tech_sex AS "techSex",
		a.tech_nation AS "techNation",
		a.tech_birth_date AS "techBirthDate",
		a.tech_email AS "techEmail",
		a.tech_education AS "techEducation",
		a.tech_height AS "techHeight",
		a.tech_weight AS "techWeight",
		a.tech_matrimony AS "techMatrimony",
		a.tech_native_place AS "techNativePlace",
		a.remarks AS "remarks",

		b.service_city_id AS "serviceInfo.serviceCityId",
		b.service_city_name AS "serviceInfo.serviceCityName",
		b.job_natrue AS "serviceInfo.jobNatrue",
		b.station_id AS "serviceInfo.stationId",
		b.station_name AS "serviceInfo.stationName",
		b.job_status AS "serviceInfo.jobStatus",
		b.work_time AS "serviceInfo.workTime",
		b.in_job_time AS "serviceInfo.inJobTime",
		b.assess_grade AS "serviceInfo.assessGrade",
		b.exper_desc AS "serviceInfo.experDesc"
	</sql>
	<resultMap type="ServiceTechnicianInfo" id="ServiceTechnicianInfoResultMap">
		<result column="id" property="id"/>
		<result column="tech_office_id" property="techOfficeId"/>
		<result column="tech_office_name" property="techOfficeName"/>
		<result column="tech_station_id" property="techStationId"/>
		<result column="tech_station_name" property="techStationName"/>
		<result column="tech_name" property="techName"/>
		<result column="tech_id_card" property="techIdCard"/>
		<result column="tech_phone" property="techPhone"/>
		<result column="addr_province_id" property="addrProvinceId"/>
		<result column="addr_city_id" property="addrCityId"/>
		<result column="addr_district_id" property="addrDistrictId"/>
		<result column="addr_province_name" property="addrProvinceName"/>
		<result column="addr_city_name" property="addrCityName"/>
		<result column="addr_district_name" property="addrDistrictName"/>
		<result column="addr_detail_info" property="addrDetailInfo"/>
		<result column="tech_sex" property="techSex"/>
		<result column="tech_nation" property="techNation"/>
		<result column="tech_birth_date" property="techBirthDate"/>
		<result column="tech_email" property="techEmail"/>
		<result column="tech_education" property="techEducation"/>
		<result column="tech_height" property="techHeight"/>
		<result column="tech_weight" property="techWeight"/>
		<result column="tech_matrimony" property="techMatrimony"/>
		<result column="tech_native_place" property="techNativePlace"/>
		<result column="remarks" property="remarks"/>
		<result column="service_city_id" property="serviceCityId"/>
		<result column="service_city_name" property="serviceCityName"/>
		<result column="job_natrue" property="jobNatrue"/>
		<result column="station_id" property="stationId"/>
		<result column="station_name" property="stationName"/>
		<result column="job_status" property="jobStatus"/>
		<result column="work_time" property="workTime"/>
		<result column="in_job_time" property="inJobTime"/>
		<result column="assess_grade" property="assessGrade"/>
		<result column="exper_desc" property="experDesc"/>

		<!-- 技能 -->
		<association property="serviceInfo.skills" column="{reqId=id}" select="selectSkillsByTechId"></association>
		<!-- 工作时间 -->
		<association property="workTimes" column="{reqId=id}" select="selectWorkTimeByTechId"></association>
		<!-- 家庭成员 -->
		<association property="familyMembers" column="{reqId=id}" select="selectFamilyMembersByTechId"></association>
		<!-- 照片 -->
		<association property="images" column="{reqId=id}" select="selectImagesByTechId"></association>
	</resultMap>
	<select id="selectSkillsByTechId" parameterType="java.util.Map" resultType="SerSkillInfo">
		select skill_id AS id,skill_name AS name
		from ser_skill_technician
		where technician_id=#{reqId}
		AND del_flag = '0'
	</select>
	<select id="selectWorkTimeByTechId" parameterType="java.util.Map" resultType="ServiceTechnicianWorkTime">
		select
		tech_id AS techId,tech_name AS techName,
		DATE_FORMAT(start_time,'%T') AS startTime, DATE_FORMAT(end_time,'%T') AS endTime,
		GROUP_CONCAT(work_date) AS workDate
		from service_technician_work_time
		where tech_id=#{reqId}
		AND del_flag = '0'
		GROUP BY tech_id,tech_name,start_time,end_time
	</select>
	<select id="selectFamilyMembersByTechId" parameterType="java.util.Map" resultType="ServiceTechnicianFamilyMembers">
		select
		relation AS relation,member_name AS memberName,
		member_phone AS memberPhone,member_unit AS memberUnit,
		member_job AS memberJob
		from service_technician_family_members
		where tech_id=#{reqId}
		AND del_flag = '0'
	</select>
	<select id="selectImagesByTechId" parameterType="java.util.Map" resultType="ServiceTechnicianImages">
		select
		img_type AS imgType,img_url AS imgUrl
		from service_technician_images
		where tech_id=#{reqId}
		AND del_flag = '0'
	</select>



    <select id="findList" resultType="ServiceTechnicianInfo">
        SELECT
			a.id AS "id",
			a.tech_office_id AS "techOfficeId",
			a.tech_office_name AS "techOfficeName",
			a.tech_name AS "techName",
			a.tech_sex AS "techSex",
			a.tech_birth_date AS "techBirthDate",
			year( from_days( datediff( now( ), a.tech_birth_date))) as age,
			a.tech_email AS "techEmail",
			b.station_id AS "serviceInfo.stationId",
			b.station_name AS "serviceInfo.stationName",
			b.job_natrue AS "serviceInfo.jobNatrue",
			b.work_time AS "serviceInfo.workTime",
			c.img_url AS "imgUrl"
        FROM service_technician_info a
		LEFT JOIN service_technician_service_info b on a.id = b.tech_id AND b.del_flag = #{DEL_FLAG_NORMAL}
		LEFT JOIN service_technician_images c ON a.id = c.tech_id AND c.img_type = '1' AND c.del_flag = #{DEL_FLAG_NORMAL}
        <include refid="serviceTechnicianInfoJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="techStationId != null and techStationId != ''">
				AND b.station_id = #{techStationId}
			</if>
			<if test="jobNatrue != null and jobNatrue != ''">
				AND b.job_natrue = #{jobNatrue}
			</if>
			<if test="techName != null and techName !=''">
				AND a.tech_name LIKE
				<if test="dbName == 'oracle'">'%'||#{techName}||'%'</if>
				<if test="dbName == 'mssql'">'%'+#{techName}+'%'</if>
				<if test="dbName == 'mysql'">concat('%',#{techName},'%')</if>
			</if>
			<if test="techPhone != null and techPhone != ''">
				AND a.tech_phone = #{techPhone}
			</if>
			<if test="skillIds != null and skillIds != ''">
				AND a.id IN(
				SELECT t1.id from service_technician_info t1
				INNER JOIN ser_skill_technician t2 on t1.id = t2.technician_id
				WHERE  t1.del_flag= #{DEL_FLAG_NORMAL} AND  t2.del_flag= #{DEL_FLAG_NORMAL}
				and t2.skill_id in
				<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
					#{skillIds}
				</foreach>
				)
			</if>
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.update_date DESC
            </otherwise>
        </choose>
    </select>

    <select id="findAllList" resultType="ServiceTechnicianInfo">
        SELECT
        <include refid="serviceTechnicianInfoColumns"/>
        FROM service_technician_info a
        <include refid="serviceTechnicianInfoJoins"/>
        <where>
            a.del_flag = #{DEL_FLAG_NORMAL}
        </where>
        <choose>
            <when test="page !=null and page.orderBy != null and page.orderBy != ''">
                ORDER BY ${page.orderBy}
            </when>
            <otherwise>
                ORDER BY a.update_date DESC
            </otherwise>
        </choose>
    </select>
    <select id="findTech"  resultType="ServiceTechnicianInfo">
        SELECT
        <include refid="serviceTechnicianInfoColumns"/>
        FROM service_technician_info a
        <include refid="serviceTechnicianInfoJoins"/>
        <where>
            <if test="true">
                a.del_flag = #{DEL_FLAG_NORMAL}
            </if>
            <if test="techPhone != null">
                AND a.tech_phone = #{techPhone}
            </if>
            <if test="techName != null">
                AND a.tech_name = #{techName}
            </if>
        </where>

    </select>

    <insert id="insert">
		INSERT INTO service_technician_info(
			id,
			tech_office_id,
			tech_office_name,
			tech_station_id,
			tech_station_name,
			tech_name,
			tech_id_card,
			tech_phone,
			status,
			app_login_password,
			bank_type,
			bank_card_no,
			addr_province_id,
			addr_city_id,
			addr_district_id,
			addr_province_name,
			addr_city_name,
			addr_district_name,
			addr_detail_info,
			tech_sex,
			tech_nation,
			tech_birth_date,
			tech_email,
			tech_education,
			tech_height,
			tech_weight,
			tech_matrimony,
			tech_native_place,
			sort,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{techOfficeId},
			#{techOfficeName},
			#{techStationId},
			#{techStationName},
			#{techName},
			#{techIdCard},
			#{techPhone},
			#{status},
			#{appLoginPassword},
			#{bankType},
			#{bankCardNo},
			#{addrProvinceId},
			#{addrCityId},
			#{addrDistrictId},
			#{addrProvinceName},
			#{addrCityName},
			#{addrDistrictName},
			#{addrDetailInfo},
			#{techSex},
			#{techNation},
			#{techBirthDate},
			#{techEmail},
			#{techEducation},
			#{techHeight},
			#{techWeight},
			#{techMatrimony},
			#{techNativePlace},
			#{sort},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>

    <update id="update">
		UPDATE service_technician_info SET 	
			tech_office_id = #{techOfficeId},
			tech_office_name = #{techOfficeName},
			tech_station_id = #{techStationId},
			tech_station_name = #{techStationName},
			tech_name = #{techName},
			tech_id_card = #{techIdCard},
			tech_phone = #{techPhone},
			status = #{status},
			app_login_password = #{appLoginPassword},
			bank_type = #{bankType},
			bank_card_no = #{bankCardNo},
			addr_province_id = #{addrProvinceId},
			addr_city_id = #{addrCityId},
			addr_district_id = #{addrDistrictId},
			addr_province_name = #{addrProvinceName},
			addr_city_name = #{addrCityName},
			addr_district_name = #{addrDistrictName},
			addr_detail_info = #{addrDetailInfo},
			tech_sex = #{techSex},
			tech_nation = #{techNation},
			tech_birth_date = #{techBirthDate},
			tech_email = #{techEmail},
			tech_education = #{techEducation},
			tech_height = #{techHeight},
			tech_weight = #{techWeight},
			tech_matrimony = #{techMatrimony},
			tech_native_place = #{techNativePlace},
			sort = #{sort},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			remarks = #{remarks}
		WHERE id = #{id}
	</update>

    <update id="delete">
		UPDATE service_technician_info SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>

	<select id="getOrderTechRelation" resultType="int">
		select count(*)
		from order_info a
		left join order_tech_relation b on a.id = b.order_id
		where a.del_flag = #{DEL_FLAG_NORMAL} and b.del_flag = #{DEL_FLAG_NORMAL}
		and b.tech_id = #{id}
		and (a.order_status = '2' or a.order_status = '4')
	</select>

	<update id="updateStatus">
		UPDATE service_technician_info SET
		status = #{status},
		update_by = #{updateBy.id},
		update_date = #{updateDate}
		WHERE id = #{id}
	</update>

	<update id="saveMoreData">
		UPDATE service_technician_info SET
		<if test="appLoginPassword != null and appLoginPassword != ''">
			app_login_password = #{appLoginPassword},
		</if>
		<if test="remarks != null and remarks != ''">
			remarks = #{remarks},
		</if>
		<if test="techEducation != null and techEducation != ''">
			tech_education = #{techEducation},
		</if>
		<if test="techEmail != null and techEmail != ''">
			tech_email = #{techEmail},
		</if>
		<if test="techHeight != null and techHeight != ''">
			tech_height = #{techHeight},
		</if>
		<if test="techMatrimony != null and techMatrimony != ''">
			tech_matrimony = #{techMatrimony},
		</if>
		<if test="techNativePlace != null and techNativePlace != ''">
			tech_native_place = #{techNativePlace},
		</if>
		<if test="techWeight != null and techWeight != ''">
			tech_weight = #{techWeight},
		</if>
		update_by = #{updateBy.id},
		update_date = #{updateDate}
		WHERE id = #{id}
	</update>

	<update id="deleteTechnicianService">
		UPDATE service_technician_service_info SET
		del_flag = #{DEL_FLAG_DELETE}
		WHERE tech_id = #{id}
		AND  del_flag = #{DEL_FLAG_NORMAL}
	</update>

	<update id="deleteTechnicianWorkTime">
		UPDATE service_technician_work_time SET
		del_flag = #{DEL_FLAG_DELETE}
		WHERE tech_id = #{id}
		AND  del_flag = #{DEL_FLAG_NORMAL}
	</update>

	<update id="deleteTechnicianHoliday">
		UPDATE service_technician_holiday SET
		del_flag = #{DEL_FLAG_DELETE}
		WHERE tech_id = #{id}
		AND  del_flag = #{DEL_FLAG_NORMAL}
	</update>

	<update id="deleteTechnicianImages">
		UPDATE service_technician_images SET
		del_flag = #{DEL_FLAG_DELETE}
		WHERE tech_id = #{id}
		AND  del_flag = #{DEL_FLAG_NORMAL}
	</update>

	<update id="delSerSkillTechnicianByTechnician">
		UPDATE ser_skill_technician SET
		del_flag = #{DEL_FLAG_DELETE}
		WHERE technician_id = #{id}
		AND  del_flag = #{DEL_FLAG_NORMAL}
	</update>

	<select id="findOfficeSeviceAreaList" resultType="ServiceTechnicianInfo">
		SELECT area_id AS addrCityId,area_name AS addrCityName
		FROM office_sevice_area_list
		WHERE office_id = #{techOfficeId}
		ORDER BY sort
	</select>

</mapper>